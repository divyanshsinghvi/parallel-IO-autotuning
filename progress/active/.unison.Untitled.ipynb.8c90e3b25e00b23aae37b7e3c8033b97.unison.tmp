{
 "cells": [
  {
   "cell_type": "code",
   "execution_count": 1,
   "metadata": {},
   "outputs": [],
   "source": [
    "# Data manipulation\n",
    "import pandas as pd\n",
    "import numpy as np\n",
    "# Evaluation of the model\n",
    "from sklearn.model_selection import KFold, train_test_split\n",
    "from sklearn.metrics import roc_auc_score\n",
    "# Visualization\n",
    "import matplotlib.pyplot as plt\n",
    "import seaborn as sns\n",
    "plt.rcParams['font.size'] = 18\n",
    "%matplotlib inline\n",
    "MAX_EVALS = 20\n",
    "import csv\n",
    "from hyperopt import STATUS_OK\n",
    "from timeit import default_timer as timer\n",
    "import json\n",
    "import shlex\n",
    "import subprocess\n",
    "import logging\n",
    "from pprint import pprint\n",
    "import re\n",
    "import os\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 2,
   "metadata": {},
   "outputs": [],
   "source": [
    "file_suffix = \"S3D-IO-400-400-800-4-4-8-1\" + str(MAX_EVALS)\n",
    "def runthebenchmark(hyperparameters):\n",
    "    os.chdir('/home/dsinghvi/project/progress/active/../')\n",
    "    storeinfile(hyperparameters)\n",
    "    out=subprocess.Popen([\"python3\",\"read_config_general.py\",\"-n 16\",\"-c400 400 800 4 4 8 1\"], shell=False, stdout=subprocess.PIPE)\n",
    "    logging.basicConfig(level=logging.DEBUG)\n",
    "    output=out.stdout.read().decode('utf-8')\n",
    "    print(\"output\"+output)\n",
    "    if len(output.split(\" \")) > 5:\n",
    "        values = output.split(\" \")\n",
    "        value = float(float(values[6])*1024)/float(values[5]) + float(float(values[3])*1024)/float(values[2])\n",
    "        value = float(value)\n",
    "        print(value)\n",
    "        return float((value/100)**3),output\n",
    "    return 0,0;"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 3,
   "metadata": {},
   "outputs": [],
   "source": [
    "def storeinfile(hyperparameters):\n",
    "    data={\"mpi\": {\"romio_ds_read\": \"enable\", \"romio_ds_write\": \"disable\"}, \"lfs\": {\"setstripe\": {\"size\": \"16777216\", \"count\": 4}}}\n",
    "    data[\"lfs\"][\"setstripe\"][\"size\"] = int(hyperparameters[\"setstripe-size\"])\n",
    "    data[\"lfs\"][\"setstripe\"][\"count\"] = int(hyperparameters[\"setstripe-count\"])\n",
    "\n",
    "    data[\"mpi\"][\"romio_ds_read\"] = hyperparameters[\"romio_ds_read\"]\n",
    "    data[\"mpi\"][\"romio_ds_write\"] = hyperparameters[\"romio_ds_write\"]\n",
    "    data[\"mpi\"][\"romio_cb_read\"] = hyperparameters[\"romio_cb_read\"]\n",
    "    data[\"mpi\"][\"romio_cb_write\"] = hyperparameters[\"romio_cb_write\"]\n",
    "    data[\"mpi\"][\"cb_buffer_size\"] = str(int(hyperparameters[\"cb_buffer_size\"]))\n",
    "    with open(\"confex.json\",\"w\") as fp:\n",
    "        json.dump(data,fp)\n",
    "    print(data)\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 4,
   "metadata": {},
   "outputs": [],
   "source": [
    "def objective(hyperparameters):\n",
    "    global ITERATION\n",
    "    ITERATION += 1\n",
    "    start = timer()\n",
    "    result=0\n",
    "    while(result == 0):\n",
    "        print(\"rerun\")\n",
    "        result,output = runthebenchmark(hyperparameters)\n",
    "        print(result)\n",
    "    run_time = timer() - start\n",
    "    print({'loss': result, 'hyperparameters': hyperparameters, 'iteration': ITERATION, 'iteration_time': run_time, 'status': STATUS_OK})\n",
    "    # Write to the csv file ('a' means append)\n",
    "    of_connection = open(out_file, 'a')\n",
    "    writer = csv.writer(of_connection)\n",
    "    writer.writerow([float(result), hyperparameters, ITERATION, run_time, output])\n",
    "    return {'loss': float(result), 'hyperparameters': hyperparameters, 'iteration': ITERATION, 'iteration_time': run_time, 'status': STATUS_OK}\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 5,
   "metadata": {},
   "outputs": [],
   "source": [
    "from hyperopt import hp\n",
    "from hyperopt.pyll.stochastic import sample\n",
    "\n",
    "space = {\n",
    "    'romio_ds_read' : hp.choice('romio_ds_read',['enable','disable']),\n",
    "    'romio_ds_write' : hp.choice('romio_ds_write',['enable','disable']),\n",
    "    'romio_cb_read' : hp.choice('romio_cb_read',['enable','disable']),\n",
    "    'romio_cb_write' : hp.choice('romio_cb_write',['enable','disable']),\n",
    "    'cb_buffer_size' : 1048576*hp.quniform('cb_buffer_size',1,512,1),\n",
    "    'setstripe-size' : 65536*(hp.quniform('setstripe-size',0,512,1)),\n",
    "    'setstripe-count' : hp.qloguniform('setstripe-count',0,5,1)\n",
    "    \n",
    "}"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 6,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "{'cb_buffer_size': 284164096.0, 'romio_cb_read': 'disable', 'romio_cb_write': 'enable', 'romio_ds_read': 'disable', 'romio_ds_write': 'enable', 'setstripe-count': 1.0, 'setstripe-size': 25493504.0}\n"
     ]
    }
   ],
   "source": [
    "x = sample(space)\n",
    "params = x\n",
    "print(x)\n",
    "\n",
    "cb_buffer_size_dist = []\n",
    "for _ in range(1000):\n",
    "    cb_buffer_size_dist.append(sample(space)['cb_buffer_size'])\n",
    "    \n",
    "setstripe_size_dist = []\n",
    "for _ in range(1000):\n",
    "    setstripe_size_dist.append(sample(space)['setstripe-size'])\n",
    "    \n",
    "setstripe_count_dist = []\n",
    "for _ in range(1000):\n",
    "    setstripe_count_dist.append(sample(space)['setstripe-count']) \n",
    "    \n",
    "romio_ds_read_dist = []\n",
    "for _ in range(20):\n",
    "    romio_ds_read_dist.append(sample(space)['romio_ds_read'])\n",
    "    \n",
    "romio_ds_write_dist = []\n",
    "for _ in range(20):\n",
    "    romio_ds_write_dist.append(sample(space)['romio_ds_write'])\n",
    "    \n",
    "romio_cb_read_dist = []\n",
    "for _ in range(20):\n",
    "    romio_cb_read_dist.append(sample(space)['romio_cb_read']) \n",
    "    \n",
    "romio_cb_write_dist = []\n",
    "for _ in range(20):\n",
    "    romio_cb_write_dist.append(sample(space)['romio_cb_write']) \n",
    "    "
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 7,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "/home/dsinghvi/project/progress/active\n"
     ]
    }
   ],
   "source": [
    "# File to save first results\n",
    "print(os.getcwd())\n",
    "out_file = '/home/dsinghvi/project/progress/active/result/gbm_trials-'+file_suffix+'.csv'\n",
    "\n",
    "of_connection = open(out_file, 'w')\n",
    "writer = csv.writer(of_connection)\n",
    "writer.writerow(['loss', 'params', 'iteration', 'train_time', 'output'])\n",
    "of_connection.close()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {
    "scrolled": true
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "rerun                                               \n",
      "{'mpi': {'romio_ds_read': 'enable', 'romio_ds_write': 'enable', 'romio_cb_read': 'disable', 'romio_cb_write': 'disable', 'cb_buffer_size': '50331648'}, 'lfs': {'setstripe': {'size': 23134208, 'count': 2}}}\n",
      "outputS3D-IO 400-400-800-4-4-8-1 1828.83 15.26 8.54 687.57 45.78 68.17 0.14 0.12 23134208 2 enable enable disable disable 50331648 \n",
      "\n",
      "76.72467886764225                                   \n",
      "0.4516533523476238                                  \n",
      "{'loss': 0.4516533523476238, 'hyperparameters': {'cb_buffer_size': 50331648.0, 'romio_cb_read': 'disable', 'romio_cb_write': 'disable', 'romio_ds_read': 'enable', 'romio_ds_write': 'enable', 'setstripe-count': 2.0, 'setstripe-size': 23134208.0}, 'iteration': 21, 'iteration_time': 86.78787598293275, 'status': 'ok'}\n",
      "  5%|▌         | 1/20 [01:26<27:29, 86.80s/it, best loss: 0.4516533523476238]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "INFO:hyperopt.tpe:tpe_transform took 0.010123 seconds\n",
      "INFO:hyperopt.tpe:TPE using 1/1 trials with best loss 0.451653\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "rerun                                                                        \n",
      "{'mpi': {'romio_ds_read': 'enable', 'romio_ds_write': 'disable', 'romio_cb_read': 'disable', 'romio_cb_write': 'disable', 'cb_buffer_size': '195035136'}, 'lfs': {'setstripe': {'size': 26738688, 'count': 11}}}\n",
      "outputS3D-IO 400-400-800-4-4-8-1 1696.77 15.26 9.21 1075.91 45.78 43.57 0.10 0.22 26738688 11 enable disable disable disable 195035136 \n",
      "\n",
      "52.78063182617481                                                            \n",
      "0.14703602530356732                                                          \n",
      "{'loss': 0.14703602530356732, 'hyperparameters': {'cb_buffer_size': 195035136.0, 'romio_cb_read': 'disable', 'romio_cb_write': 'disable', 'romio_ds_read': 'enable', 'romio_ds_write': 'disable', 'setstripe-count': 11.0, 'setstripe-size': 26738688.0}, 'iteration': 22, 'iteration_time': 71.716807003133, 'status': 'ok'}\n",
      " 10%|█         | 2/20 [02:38<24:41, 82.28s/it, best loss: 0.14703602530356732]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "INFO:hyperopt.tpe:tpe_transform took 0.009649 seconds\n",
      "INFO:hyperopt.tpe:TPE using 2/2 trials with best loss 0.147036\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "rerun                                                                         \n",
      "{'mpi': {'romio_ds_read': 'disable', 'romio_ds_write': 'disable', 'romio_cb_read': 'disable', 'romio_cb_write': 'enable', 'cb_buffer_size': '333447168'}, 'lfs': {'setstripe': {'size': 25427968, 'count': 14}}}\n",
      "outputS3D-IO 400-400-800-4-4-8-1 2049.05 15.26 7.63 1236.28 45.78 37.92 0.12 0.14 25427968 14 disable disable disable enable 333447168 \n",
      "\n",
      "45.54526702482806                                                             \n",
      "0.09447779696984045                                                           \n",
      "{'loss': 0.09447779696984045, 'hyperparameters': {'cb_buffer_size': 333447168.0, 'romio_cb_read': 'disable', 'romio_cb_write': 'enable', 'romio_ds_read': 'disable', 'romio_ds_write': 'disable', 'setstripe-count': 14.0, 'setstripe-size': 25427968.0}, 'iteration': 23, 'iteration_time': 70.35506447870284, 'status': 'ok'}\n",
      " 15%|█▌        | 3/20 [03:48<22:18, 78.71s/it, best loss: 0.09447779696984045]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "INFO:hyperopt.tpe:tpe_transform took 0.009585 seconds\n",
      "INFO:hyperopt.tpe:TPE using 3/3 trials with best loss 0.094478\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "rerun                                                                         \n",
      "{'mpi': {'romio_ds_read': 'enable', 'romio_ds_write': 'disable', 'romio_cb_read': 'disable', 'romio_cb_write': 'enable', 'cb_buffer_size': '83886080'}, 'lfs': {'setstripe': {'size': 22609920, 'count': 8}}}\n",
      "outputS3D-IO 400-400-800-4-4-8-1 1334.53 15.26 11.71 823.73 45.78 56.91 0.13 0.12 22609920 8 enable disable disable enable 83886080 \n",
      "\n",
      "68.6194692963586                                                              \n",
      "0.32310379920626553                                                           \n",
      "{'loss': 0.32310379920626553, 'hyperparameters': {'cb_buffer_size': 83886080.0, 'romio_cb_read': 'disable', 'romio_cb_write': 'enable', 'romio_ds_read': 'enable', 'romio_ds_write': 'disable', 'setstripe-count': 8.0, 'setstripe-size': 22609920.0}, 'iteration': 24, 'iteration_time': 81.22335851658136, 'status': 'ok'}\n",
      " 20%|██        | 4/20 [05:10<21:11, 79.48s/it, best loss: 0.09447779696984045]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "INFO:hyperopt.tpe:tpe_transform took 0.009602 seconds\n",
      "INFO:hyperopt.tpe:TPE using 4/4 trials with best loss 0.094478\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "rerun                                                                         \n",
      "{'mpi': {'romio_ds_read': 'enable', 'romio_ds_write': 'disable', 'romio_cb_read': 'disable', 'romio_cb_write': 'disable', 'cb_buffer_size': '403701760'}, 'lfs': {'setstripe': {'size': 2162688, 'count': 79}}}\n",
      "outputS3D-IO 400-400-800-4-4-8-1 1953.32 15.26 8.00 1275.80 45.78 36.74 0.09 0.59 2162688 79 enable disable disable disable 403701760 \n",
      "\n",
      "44.74440429048063                                                             \n",
      "0.08958105880432296                                                           \n",
      "{'loss': 0.08958105880432296, 'hyperparameters': {'cb_buffer_size': 403701760.0, 'romio_cb_read': 'disable', 'romio_cb_write': 'disable', 'romio_ds_read': 'enable', 'romio_ds_write': 'disable', 'setstripe-count': 79.0, 'setstripe-size': 2162688.0}, 'iteration': 25, 'iteration_time': 57.5177634274587, 'status': 'ok'}\n",
      " 25%|██▌       | 5/20 [06:07<18:13, 72.90s/it, best loss: 0.08958105880432296]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "INFO:hyperopt.tpe:tpe_transform took 0.010548 seconds\n",
      "INFO:hyperopt.tpe:TPE using 5/5 trials with best loss 0.089581\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "rerun                                                                         \n",
      "{'mpi': {'romio_ds_read': 'enable', 'romio_ds_write': 'disable', 'romio_cb_read': 'disable', 'romio_cb_write': 'enable', 'cb_buffer_size': '200278016'}, 'lfs': {'setstripe': {'size': 11862016, 'count': 6}}}\n",
      "outputS3D-IO 400-400-800-4-4-8-1 1799.16 15.26 8.68 670.90 45.78 69.87 0.11 0.14 11862016 6 enable disable disable enable 200278016 \n",
      "\n",
      "78.55967528491153                                                             \n",
      "0.48484066593423303                                                           \n",
      "{'loss': 0.48484066593423303, 'hyperparameters': {'cb_buffer_size': 200278016.0, 'romio_cb_read': 'disable', 'romio_cb_write': 'enable', 'romio_ds_read': 'enable', 'romio_ds_write': 'disable', 'setstripe-count': 6.0, 'setstripe-size': 11862016.0}, 'iteration': 26, 'iteration_time': 91.3156544873491, 'status': 'ok'}\n",
      " 30%|███       | 6/20 [07:39<18:18, 78.43s/it, best loss: 0.08958105880432296]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "INFO:hyperopt.tpe:tpe_transform took 0.009892 seconds\n",
      "INFO:hyperopt.tpe:TPE using 6/6 trials with best loss 0.089581\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "rerun                                                                         \n",
      "{'mpi': {'romio_ds_read': 'disable', 'romio_ds_write': 'enable', 'romio_cb_read': 'disable', 'romio_cb_write': 'enable', 'cb_buffer_size': '255852544'}, 'lfs': {'setstripe': {'size': 20905984, 'count': 15}}}\n",
      "outputS3D-IO 400-400-800-4-4-8-1 2467.69 15.26 6.33 1108.83 45.78 42.27 0.10 0.05 20905984 15 disable enable disable enable 255852544 \n",
      "\n",
      "48.60997910195556                                                             \n",
      "0.11486198123908357                                                           \n",
      "{'loss': 0.11486198123908357, 'hyperparameters': {'cb_buffer_size': 255852544.0, 'romio_cb_read': 'disable', 'romio_cb_write': 'enable', 'romio_ds_read': 'disable', 'romio_ds_write': 'enable', 'setstripe-count': 15.0, 'setstripe-size': 20905984.0}, 'iteration': 27, 'iteration_time': 62.06723676994443, 'status': 'ok'}\n",
      " 35%|███▌      | 7/20 [08:41<15:55, 73.53s/it, best loss: 0.08958105880432296]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "INFO:hyperopt.tpe:tpe_transform took 0.009775 seconds\n",
      "INFO:hyperopt.tpe:TPE using 7/7 trials with best loss 0.089581\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "rerun                                                                         \n",
      "{'mpi': {'romio_ds_read': 'enable', 'romio_ds_write': 'disable', 'romio_cb_read': 'disable', 'romio_cb_write': 'disable', 'cb_buffer_size': '532676608'}, 'lfs': {'setstripe': {'size': 28114944, 'count': 3}}}\n",
      "outputS3D-IO 400-400-800-4-4-8-1 1857.59 15.26 8.41 1061.67 45.78 44.15 0.25 0.98 28114944 3 enable disable disable disable 532676608 \n",
      "\n",
      "52.56774543853782                                                             \n",
      "0.14526401824332322                                                           \n",
      "{'loss': 0.14526401824332322, 'hyperparameters': {'cb_buffer_size': 532676608.0, 'romio_cb_read': 'disable', 'romio_cb_write': 'disable', 'romio_ds_read': 'enable', 'romio_ds_write': 'disable', 'setstripe-count': 3.0, 'setstripe-size': 28114944.0}, 'iteration': 28, 'iteration_time': 65.47690468095243, 'status': 'ok'}\n",
      " 40%|████      | 8/20 [09:46<14:13, 71.13s/it, best loss: 0.08958105880432296]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "INFO:hyperopt.tpe:tpe_transform took 0.006928 seconds\n",
      "INFO:hyperopt.tpe:TPE using 8/8 trials with best loss 0.089581\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "rerun                                                                         \n",
      "{'mpi': {'romio_ds_read': 'disable', 'romio_ds_write': 'disable', 'romio_cb_read': 'enable', 'romio_cb_write': 'disable', 'cb_buffer_size': '27262976'}, 'lfs': {'setstripe': {'size': 23003136, 'count': 2}}}\n",
      "outputS3D-IO 400-400-800-4-4-8-1 1124.75 15.26 13.89 461.44 45.78 101.58 0.15 0.12 23003136 2 disable disable enable disable 27262976 \n",
      "\n",
      "115.48531147158916                                                            \n",
      "1.5402111038318012                                                            \n",
      "{'loss': 1.5402111038318012, 'hyperparameters': {'cb_buffer_size': 27262976.0, 'romio_cb_read': 'enable', 'romio_cb_write': 'disable', 'romio_ds_read': 'disable', 'romio_ds_write': 'disable', 'setstripe-count': 2.0, 'setstripe-size': 23003136.0}, 'iteration': 29, 'iteration_time': 131.89830394182354, 'status': 'ok'}\n",
      " 45%|████▌     | 9/20 [11:58<16:23, 89.37s/it, best loss: 0.08958105880432296]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "INFO:hyperopt.tpe:tpe_transform took 0.009638 seconds\n",
      "INFO:hyperopt.tpe:TPE using 9/9 trials with best loss 0.089581\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "rerun                                                                         \n",
      "{'mpi': {'romio_ds_read': 'enable', 'romio_ds_write': 'enable', 'romio_cb_read': 'enable', 'romio_cb_write': 'disable', 'cb_buffer_size': '281018368'}, 'lfs': {'setstripe': {'size': 19595264, 'count': 21}}}\n",
      "outputS3D-IO 400-400-800-4-4-8-1 1916.79 15.26 8.15 1229.86 45.78 38.11 0.11 0.53 19595264 21 enable enable enable disable 281018368 \n",
      "\n",
      "46.2694153086988                                                              \n",
      "0.09905628461100614                                                           \n",
      "{'loss': 0.09905628461100614, 'hyperparameters': {'cb_buffer_size': 281018368.0, 'romio_cb_read': 'enable', 'romio_cb_write': 'disable', 'romio_ds_read': 'enable', 'romio_ds_write': 'enable', 'setstripe-count': 21.0, 'setstripe-size': 19595264.0}, 'iteration': 30, 'iteration_time': 63.606230690144, 'status': 'ok'}\n",
      " 50%|█████     | 10/20 [13:02<13:36, 81.65s/it, best loss: 0.08958105880432296]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "INFO:hyperopt.tpe:tpe_transform took 0.009815 seconds\n",
      "INFO:hyperopt.tpe:TPE using 10/10 trials with best loss 0.089581\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "rerun                                                                          \n",
      "{'mpi': {'romio_ds_read': 'enable', 'romio_ds_write': 'disable', 'romio_cb_read': 'disable', 'romio_cb_write': 'enable', 'cb_buffer_size': '150994944'}, 'lfs': {'setstripe': {'size': 11010048, 'count': 1}}}\n",
      "outputS3D-IO 400-400-800-4-4-8-1 916.91 15.26 17.04 303.08 45.78 154.66 0.12 0.48 11010048 1 enable disable disable enable 150994944 \n",
      "\n",
      "171.71669271801366                                                             \n",
      "5.0633453050863215                                                             \n",
      "{'loss': 5.0633453050863215, 'hyperparameters': {'cb_buffer_size': 150994944.0, 'romio_cb_read': 'disable', 'romio_cb_write': 'enable', 'romio_ds_read': 'enable', 'romio_ds_write': 'disable', 'setstripe-count': 1.0, 'setstripe-size': 11010048.0}, 'iteration': 31, 'iteration_time': 197.7369105629623, 'status': 'ok'}\n",
      " 55%|█████▌    | 11/20 [16:20<17:28, 116.48s/it, best loss: 0.08958105880432296]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "INFO:hyperopt.tpe:tpe_transform took 0.010066 seconds\n",
      "INFO:hyperopt.tpe:TPE using 11/11 trials with best loss 0.089581\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "rerun                                                                           \n",
      "{'mpi': {'romio_ds_read': 'enable', 'romio_ds_write': 'enable', 'romio_cb_read': 'enable', 'romio_cb_write': 'disable', 'cb_buffer_size': '411041792'}, 'lfs': {'setstripe': {'size': 6684672, 'count': 43}}}\n",
      "outputS3D-IO 400-400-800-4-4-8-1 2265.28 15.26 6.90 1154.04 45.78 40.62 0.10 0.64 6684672 43 enable enable enable disable 411041792 \n",
      "\n",
      "47.519549061004255                                                              \n",
      "0.10730425217276807                                                             \n",
      "{'loss': 0.10730425217276807, 'hyperparameters': {'cb_buffer_size': 411041792.0, 'romio_cb_read': 'enable', 'romio_cb_write': 'disable', 'romio_ds_read': 'enable', 'romio_ds_write': 'enable', 'setstripe-count': 43.0, 'setstripe-size': 6684672.0}, 'iteration': 32, 'iteration_time': 59.68877911474556, 'status': 'ok'}\n",
      " 60%|██████    | 12/20 [17:19<13:15, 99.45s/it, best loss: 0.08958105880432296] "
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "INFO:hyperopt.tpe:tpe_transform took 0.010305 seconds\n",
      "INFO:hyperopt.tpe:TPE using 12/12 trials with best loss 0.089581\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "rerun                                                                          \n",
      "{'mpi': {'romio_ds_read': 'enable', 'romio_ds_write': 'enable', 'romio_cb_read': 'disable', 'romio_cb_write': 'disable', 'cb_buffer_size': '233832448'}, 'lfs': {'setstripe': {'size': 20054016, 'count': 3}}}\n",
      "outputS3D-IO 400-400-800-4-4-8-1 1610.82 15.26 9.70 1021.79 45.78 45.88 0.19 0.35 20054016 3 enable enable disable disable 233832448 \n",
      "\n",
      "55.57981458736327                                                              \n",
      "0.17169248282295677                                                            \n",
      "{'loss': 0.17169248282295677, 'hyperparameters': {'cb_buffer_size': 233832448.0, 'romio_cb_read': 'disable', 'romio_cb_write': 'disable', 'romio_ds_read': 'enable', 'romio_ds_write': 'enable', 'setstripe-count': 3.0, 'setstripe-size': 20054016.0}, 'iteration': 33, 'iteration_time': 68.21590972319245, 'status': 'ok'}\n",
      " 65%|██████▌   | 13/20 [18:27<10:30, 90.09s/it, best loss: 0.08958105880432296]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "INFO:hyperopt.tpe:tpe_transform took 0.009907 seconds\n",
      "INFO:hyperopt.tpe:TPE using 13/13 trials with best loss 0.089581\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "rerun                                                                          \n",
      "{'mpi': {'romio_ds_read': 'enable', 'romio_ds_write': 'enable', 'romio_cb_read': 'enable', 'romio_cb_write': 'disable', 'cb_buffer_size': '315621376'}, 'lfs': {'setstripe': {'size': 31588352, 'count': 80}}}\n",
      "outputS3D-IO 400-400-800-4-4-8-1 1794.16 15.26 8.71 1328.43 45.78 35.29 0.15 0.31 31588352 80 enable enable enable disable 315621376 \n",
      "\n",
      "43.99831655537576                                                              \n",
      "0.08517422292770377                                                            \n",
      "{'loss': 0.08517422292770377, 'hyperparameters': {'cb_buffer_size': 315621376.0, 'romio_cb_read': 'enable', 'romio_cb_write': 'disable', 'romio_ds_read': 'enable', 'romio_ds_write': 'enable', 'setstripe-count': 80.0, 'setstripe-size': 31588352.0}, 'iteration': 34, 'iteration_time': 55.87313009891659, 'status': 'ok'}\n",
      " 70%|███████   | 14/20 [19:23<07:59, 79.83s/it, best loss: 0.08517422292770377]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "INFO:hyperopt.tpe:tpe_transform took 0.014057 seconds\n",
      "INFO:hyperopt.tpe:TPE using 14/14 trials with best loss 0.085174\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "rerun                                                                          \n",
      "{'mpi': {'romio_ds_read': 'disable', 'romio_ds_write': 'enable', 'romio_cb_read': 'disable', 'romio_cb_write': 'enable', 'cb_buffer_size': '514850816'}, 'lfs': {'setstripe': {'size': 917504, 'count': 58}}}\n",
      "outputS3D-IO 400-400-800-4-4-8-1 2121.95 15.26 7.36 1286.20 45.78 36.44 0.47 1.47 917504 58 disable enable disable enable 514850816 \n",
      "\n",
      "43.811551974299306                                                             \n",
      "0.08409417484534755                                                            \n",
      "{'loss': 0.08409417484534755, 'hyperparameters': {'cb_buffer_size': 514850816.0, 'romio_cb_read': 'disable', 'romio_cb_write': 'enable', 'romio_ds_read': 'disable', 'romio_ds_write': 'enable', 'setstripe-count': 58.0, 'setstripe-size': 917504.0}, 'iteration': 35, 'iteration_time': 58.200872579589486, 'status': 'ok'}\n",
      " 75%|███████▌  | 15/20 [20:22<06:06, 73.36s/it, best loss: 0.08409417484534755]"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "INFO:hyperopt.tpe:tpe_transform took 0.009913 seconds\n",
      "INFO:hyperopt.tpe:TPE using 15/15 trials with best loss 0.084094\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "rerun                                                                          \n",
      "{'mpi': {'romio_ds_read': 'disable', 'romio_ds_write': 'enable', 'romio_cb_read': 'enable', 'romio_cb_write': 'disable', 'cb_buffer_size': '208666624'}, 'lfs': {'setstripe': {'size': 12517376, 'count': 10}}}\n",
      " 75%|███████▌  | 15/20 [20:22<06:06, 73.36s/it, best loss: 0.08409417484534755]"
     ]
    }
   ],
   "source": [
    "from hyperopt import tpe\n",
    "\n",
    "# Create the algorithm\n",
    "tpe_algorithm = tpe.suggest\n",
    "\n",
    "\n",
    "from hyperopt import Trials\n",
    "\n",
    "# Record results\n",
    "bayes_trials = Trials()\n",
    "\n",
    "from hyperopt import fmin\n",
    "\n",
    "\n",
    "ITERATION = 20\n",
    "\n",
    "best = fmin(fn = objective, space = space, algo = tpe.suggest, trials = bayes_trials, max_evals = MAX_EVALS)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "print(best)\n",
    "d=  best\n",
    "#print(bayes_trials.results)\n",
    "bayes_trials_results = sorted(bayes_trials.results, key = lambda x: x['loss'])\n",
    "#bayes_trials_results[:1]"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "results = pd.read_csv(out_file)\n",
    "\n",
    "# Sort with best scores on top and reset index for slicing\n",
    "results.sort_values('train_time', ascending = True, inplace = True)\n",
    "results.reset_index(inplace = True, drop = True)\n",
    "results.head()\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "import ast\n",
    "\n",
    "# Convert from a string to a dictionary\n",
    "ast.literal_eval(results.loc[0, 'params'])\n",
    "best_bayes_params = ast.literal_eval(results.loc[0, 'params']).copy()\n",
    "print(best_bayes_params)\n",
    "log = open('best.txt','a')\n",
    "print(results.loc[0,'output'])\n",
    "print(results.loc[0,'output'],file=log)\n",
    "log.close()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "bayes_params = pd.DataFrame(columns = list(ast.literal_eval(results.loc[0, 'params']).keys()),\n",
    "                            index = list(range(len(results))))\n",
    "\n",
    "# Add the results with each parameter a different column\n",
    "for i, params in enumerate(results['params']):\n",
    "    bayes_params.loc[i, :] = list(ast.literal_eval(params).values())\n",
    "bayes_params['train_time'] = results['train_time']    \n",
    "bayes_params['loss'] = results['loss']\n",
    "bayes_params['iteration'] = results['iteration']\n",
    "bayes_params['output']=results['output']\n",
    "\n",
    "bayes_params.head()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "os.chdir('./plots')\n",
    "plt.figure(figsize = (20, 8))\n",
    "plt.rcParams['font.size'] = 18\n",
    "\n",
    "# Density plots of the learning rate distributions \n",
    "sns.kdeplot(bayes_params['loss'], label = 'Loss Variation', linewidth = 2)\n",
    "plt.legend()\n",
    "plt.xlabel('Loss'); plt.ylabel('Density'); plt.title('Loss Distribution');\n",
    "plt.savefig(file_suffix+'_loss.png')"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {
    "scrolled": true
   },
   "outputs": [],
   "source": [
    "plt.figure(figsize = (20, 8))\n",
    "plt.rcParams['font.size'] = 18\n",
    "\n",
    "\n",
    "sns.kdeplot(bayes_params['cb_buffer_size'], label = 'bayes cb_buffer_size', linewidth = 2)\n",
    "sns.kdeplot(cb_buffer_size_dist,color=\"red\",linewidth=2, label = 'initial cb_buffer_size')\n",
    "\n",
    "plt.legend()\n",
    "plt.xlabel('cb_buffer_size'); plt.ylabel('Density'); plt.title('cb_buffer_size Distribution');\n",
    "plt.savefig(file_suffix+'_cb_buffer_size.png')"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "plt.figure(figsize = (20, 8))\n",
    "plt.rcParams['font.size'] = 18\n",
    "\n",
    "sns.kdeplot(bayes_params['setstripe-size'], label = 'bayes setstripe-size', linewidth = 2)\n",
    "sns.kdeplot(setstripe_size_dist,color=\"red\",linewidth=2, label = 'initial setstripe-size')\n",
    "\n",
    "plt.legend()\n",
    "plt.xlabel('setstripe-size'); plt.ylabel('Density'); plt.title('setstripe-size Distribution');\n",
    "plt.savefig(file_suffix+'_setstripe-size.png')"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "plt.figure(figsize = (20, 8))\n",
    "plt.rcParams['font.size'] = 18\n",
    "\n",
    "sns.kdeplot(bayes_params['setstripe-count'], label = 'bayes setstripe-count', linewidth = 2)\n",
    "sns.kdeplot(setstripe_count_dist,color=\"red\",linewidth=2, label = 'initial setstripe-count')\n",
    "\n",
    "plt.legend()\n",
    "plt.xlabel('setstripe-count'); plt.ylabel('Density'); plt.title('setstripe-count Distribution');\n",
    "plt.savefig(file_suffix+'_setstripe-count.png')"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "plt.figure(figsize = (20, 8))\n",
    "from scipy.stats import itemfreq\n",
    "plt.rcParams['font.size'] = 18\n",
    "bayes_params['romio_ds_read'].value_counts().plot.bar()#plt.hist(romio_ds_read_dist,co